---
layout: post
bigtitle: 'ì´í™í‹°ë¸Œ ìë°” ì™„ë²½ ê³µëµ 1ë¶€'
subtitle: ì•„ì´í…œ 8. finalizerì™€ cleaner ì‚¬ìš©ì„ í”¼í•˜ë¼
date: '2026-01-22 00:00:01 +0900'
categories:
- effective-java1
comments: true

---

# ì•„ì´í…œ 8. finalizerì™€ cleaner ì‚¬ìš©ì„ í”¼í•˜ë¼

# ì•„ì´í…œ 8. finalizerì™€ cleaner ì‚¬ìš©ì„ í”¼í•˜ë¼

* toc
{:toc}

ìë°”ì—ì„œ ê°ì²´ì˜ ìƒëª… ì£¼ê¸°ëŠ” GCê°€ ê´€ë¦¬í•˜ì§€ë§Œ,
**ìì›ì˜ ìƒëª… ì£¼ê¸°ê¹Œì§€ GCì— ë§¡ê¸°ëŠ” ìˆœê°„ ìœ„í—˜í•´ì§„ë‹¤.**
`finalizer`ì™€ `cleaner`ëŠ” ê·¸ ëŒ€í‘œì ì¸ ì˜ˆë‹¤.

ìë°”ì—ì„œ ìì› ì •ë¦¬ëŠ” ìƒê°ë³´ë‹¤ ìœ„í—˜í•œ ì£¼ì œë‹¤.
ê²‰ë³´ê¸°ì—ëŠ” â€œGCê°€ ì•Œì•„ì„œ ì •ë¦¬í•´ì£¼ê² ì§€â€ë¼ëŠ” ìœ í˜¹ì´ ê°•í•˜ì§€ë§Œ, finalizerì™€ cleanerëŠ” ê·¸ ê¸°ëŒ€ë¥¼ ì •ë©´ìœ¼ë¡œ ë°°ì‹ í•œë‹¤.

ì´ ì•„ì´í…œì˜ í•µì‹¬ ë©”ì‹œì§€ëŠ” ë‹¨ìˆœí•˜ë‹¤.

ìì›ì„ ë°˜ë‚©í•´ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ëŠ” AutoCloseableì„ êµ¬í˜„í•˜ê³ ,
í´ë¼ì´ì–¸íŠ¸ê°€ ëª…ì‹œì ìœ¼ë¡œ close()ë¥¼ í˜¸ì¶œí•˜ê²Œ í•˜ë¼.

ê·¸ ì™¸ì˜ ë°©ë²•ì€ ëª¨ë‘ â€œì•ˆì „ë§â€ì¼ ë¿ì´ë‹¤.

---

## í•µì‹¬ ì •ë¦¬

* `finalizer`ì™€ `cleaner`ëŠ” **ì¦‰ì‹œ ìˆ˜í–‰ëœë‹¤ëŠ” ë³´ì¥ì´ ì—†ë‹¤**
* ê²½ìš°ì— ë”°ë¼ **ì•„ì˜ˆ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤**
* `finalizer` ì‹¤í–‰ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ **ì •ë¦¬ ì‘ì—…ì´ ì²˜ë¦¬ë˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤**
* ë‘ ë©”ì»¤ë‹ˆì¦˜ ëª¨ë‘ **ì‹¬ê°í•œ ì„±ëŠ¥ ë¬¸ì œë¥¼ ìœ ë°œí•  ìˆ˜ ìˆë‹¤**
* `finalizer`ëŠ” **ë³´ì•ˆ ì·¨ì•½ì (finalizer attack)**ì˜ ì›ì¸ì´ ëœë‹¤
* ìì›ì„ ë°˜ë‚©í•´ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ëŠ” ë°˜ë“œì‹œ
  **`AutoCloseable`ì„ êµ¬í˜„í•˜ê³ , `close()` í˜¸ì¶œ ë˜ëŠ” `try-with-resources`ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤**

---

## finalizerì˜ ë¬¸ì œì 

```java
public class FinalizerIsBad {

    @Override
    protected void finalize() throws Throwable {
        System.out.print("");
    }
}
```

`finalize()`ëŠ” ê°ì²´ê°€ GC ëŒ€ìƒì´ ë˜ì—ˆì„ ë•Œ **í˜¸ì¶œë  ìˆ˜ë„ ìˆëŠ” ë©”ì„œë“œ**ë‹¤.
ì–¸ì œ ì‹¤í–‰ë ì§€, ì‹¬ì§€ì–´ ì‹¤í–‰ë ì§€ì¡°ì°¨ **ì „í˜€ ë³´ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤**.

---

### finalizer í ì ì²´ ë¬¸ì œ

```java
public class App {

    /**
     * ì½”ë“œ ì°¸ê³  https://www.baeldung.com/java-finalize
     */
    public static void main(String[] args) throws InterruptedException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException {
        int i = 0;
        while(true) {
            i++;
            new FinalizerIsBad();

            if ((i % 1_000_000) == 0) {
                Class<?> finalizerClass = Class.forName("java.lang.ref.Finalizer");
                Field queueStaticField = finalizerClass.getDeclaredField("queue");
                queueStaticField.setAccessible(true);
                ReferenceQueue<Object> referenceQueue = (ReferenceQueue) queueStaticField.get(null);

                Field queueLengthField = ReferenceQueue.class.getDeclaredField("queueLength");
                queueLengthField.setAccessible(true);
                long queueLength = (long) queueLengthField.get(referenceQueue);
                System.out.format("There are %d references in the queue%n", queueLength);
            }
        }
    }
}
```

* `finalize()`ê°€ ì •ì˜ëœ ê°ì²´ëŠ” **Finalizer í**ë¡œ ì´ë™í•œë‹¤
* ì´ íëŠ” **ë‹¨ì¼ ìŠ¤ë ˆë“œ**ì—ì„œ ì²˜ë¦¬ëœë‹¤
* ê°ì²´ ìƒì„± ì†ë„ê°€ ì²˜ë¦¬ ì†ë„ë¥¼ ì•ì§€ë¥´ë©´ íê°€ ë¹ ë¥´ê²Œ ì ì²´ëœë‹¤
* ê·¸ ê²°ê³¼ GC ì§€ì—°, ë©”ëª¨ë¦¬ ì¦ê°€, ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ ì €í•˜ë¡œ ì´ì–´ì§„ë‹¤

### ë³´ì•ˆ ë¬¸ì œ: Finalizer Attack

ìƒì„±ìê°€ ì˜ˆì™¸ë¥¼ ë˜ì ¸ ê°ì²´ ìƒì„±ì´ ì‹¤íŒ¨í–ˆëŠ”ë°ë„,
finalize()ê°€ ì‹¤í–‰ë˜ë©´ì„œ ë¯¸ì™„ì„± ê°ì²´ì— ì ‘ê·¼ ê°€ëŠ¥í•´ì§€ëŠ” ë¬¸ì œê°€ ìˆë‹¤.

ê·¸ë˜ì„œ ë³´ì•ˆì ìœ¼ë¡œ ì¤‘ìš”í•œ í´ë˜ìŠ¤ëŠ” ì•„ì˜ˆ finalize()ë¥¼ ë‘ë©´ ì•ˆ ëœë‹¤.

---

## Cleaner ì‚¬ìš©ë²•

CleanerëŠ” Java 9ë¶€í„° ë„ì…ë˜ì—ˆì§€ë§Œ,
**finalizerì˜ ì•ˆì „í•œ ëŒ€ì²´ì¬ê°€ ì•„ë‹ˆë¼ â€œì œí•œì ì¸ ë³´ì¡° ìˆ˜ë‹¨â€**ì— ê°€ê¹ë‹¤.

### Cleanerì˜ ì •ì²´
+ ë‚´ë¶€ì ìœ¼ë¡œ PhantomReference ì‚¬ìš©
+ ê°ì²´ê°€ GC ëŒ€ìƒì´ ë˜ë©´ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ Runnable ì‹¤í–‰
+ ì‹¤í–‰ ë³´ì¥ ì—†ìŒ (ì¤‘ìš”)

### ìì› ë°˜ë‚©ìš© ì•ˆì „ë§ìœ¼ë¡œ ì‚¬ìš©

* ë‚´ë¶€ì ìœ¼ë¡œ `PhantomReference`ë¥¼ ì‚¬ìš©í•œë‹¤
* ê°ì²´ê°€ GC ëŒ€ìƒì´ ëœ ì´í›„ì— ë™ì‘í•œë‹¤
* í˜¸ì¶œ ì—¬ë¶€ëŠ” ì—¬ì „íˆ ë³´ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤
* ë‹¤ë§Œ `close()` í˜¸ì¶œì„ ë†“ì³¤ì„ ë•Œì˜ **ìµœí›„ì˜ ì•ˆì „ë§**ìœ¼ë¡œëŠ” ì˜ë¯¸ê°€ ìˆë‹¤

### ë„¤ì´í‹°ë¸Œ í”¼ì–´(native peer) ìì› íšŒìˆ˜

* JNIë¡œ í• ë‹¹ëœ ë©”ëª¨ë¦¬
* OS ë ˆë²¨ ë¦¬ì†ŒìŠ¤
* ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ ìƒíƒœ ë“±

ë‹¨, ë‹¤ìŒ ì¡°ê±´ì„ ë§Œì¡±í•´ì•¼ í•œë‹¤.

* ì„±ëŠ¥ ì €í•˜ë¥¼ ê°ë‹¹í•  ìˆ˜ ìˆì„ ê²ƒ
* ë„¤ì´í‹°ë¸Œ í”¼ì–´ê°€ **ì¹˜ëª…ì ì¸ ìì›**ì„ ë“¤ê³  ìˆì§€ ì•Šì„ ê²ƒ
* ì¦‰ì‹œ íšŒìˆ˜ë˜ì§€ ì•Šì•„ë„ ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ì—†ì„ ê²ƒ

ğŸ‘‰ **ì¦‰ì‹œ ìì› íšŒìˆ˜ê°€ í•„ìš”í•˜ë‹¤ë©´ Cleanerê°€ ì•„ë‹ˆë¼ `close()`ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.**

---

### ì˜ëª»ëœ Cleaner ì‚¬ìš© ì˜ˆ

```java
public class BigObject {

    private List<Object> resource;

    public BigObject(List<Object> resource) {
        this.resource = resource;
    }

    public static class ResourceCleaner implements Runnable {

        private List<Object> resourceToClean;

        public ResourceCleaner(List<Object> resourceToClean) {
            this.resourceToClean = resourceToClean;
        }

        @Override
        public void run() {
            resourceToClean = null;
            System.out.println("cleaned up.");
        }
    }
}
```

```java
public class CleanerIsNotGood {

    public static void main(String[] args) throws InterruptedException {
        Cleaner cleaner = Cleaner.create();

        List<Object> resourceToCleanUp = new ArrayList<>();
        BigObject bigObject = new BigObject(resourceToCleanUp);
        cleaner.register(bigObject, new BigObject.ResourceCleaner(resourceToCleanUp));

        bigObject = null;
        System.gc();
        Thread.sleep(3000L);
    }
}
```

* `System.gc()` í˜¸ì¶œì— ì˜ì¡´í•œë‹¤
* ì‹¤í–‰ ì—¬ë¶€ê°€ ë¶ˆí™•ì‹¤í•˜ë‹¤
* ì¦‰ì‹œ ìì› ë°˜ë‚©ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤
  â†’ ì£¼ ìì› ê´€ë¦¬ ë°©ì‹ìœ¼ë¡œëŠ” ë¶€ì ì ˆí•˜ë‹¤

---

## Cleaner + AutoCloseable íŒ¨í„´

```java
// cleaner ì•ˆì „ë§ì„ ê°–ì¶˜ ìì›ì„ ì œëŒ€ë¡œ í™œìš©í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸
public class Adult {
    public static void main(String[] args) {
        try (Room myRoom = new Room(7)) {
            System.out.println("ì•ˆë…•~");
        }
    }
}
```

```java
// ì½”ë“œ 8-1 cleanerë¥¼ ì•ˆì „ë§ìœ¼ë¡œ í™œìš©í•˜ëŠ” AutoCloseable í´ë˜ìŠ¤
public class Room implements AutoCloseable {
    private static final Cleaner cleaner = Cleaner.create();

    // ì²­ì†Œê°€ í•„ìš”í•œ ìì›. ì ˆëŒ€ Roomì„ ì°¸ì¡°í•´ì„œëŠ” ì•ˆ ëœë‹¤!
    private static class State implements Runnable {
        int numJunkPiles;

        State(int numJunkPiles) {
            this.numJunkPiles = numJunkPiles;
        }

        @Override public void run() {
            System.out.println("Cleaning room");
            numJunkPiles = 0;
        }
    }

    private final State state;
    private final Cleaner.Cleanable cleanable;

    public Room(int numJunkPiles) {
        state = new State(numJunkPiles);
        cleanable = cleaner.register(this, state);
    }

    @Override public void close() {
        cleanable.clean();
    }
}
```

* ì •ìƒì ì¸ ê²½ìš° `close()`ê°€ ì¦‰ì‹œ ìì›ì„ ë°˜ë‚©í•œë‹¤
* `close()`ê°€ í˜¸ì¶œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ì—ë§Œ Cleanerê°€ ì•ˆì „ë§ ì—­í• ì„ í•œë‹¤

---

```java
// cleaner ì•ˆì „ë§ì„ ê°–ì¶˜ ìì›ì„ ì œëŒ€ë¡œ í™œìš©í•˜ì§€ ëª»í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸
public class Teenager {

    public static void main(String[] args) {
        new Room(99);
        System.out.println("Peace out");

        // GC í˜¸ì¶œì— ì˜ì¡´í•´ì„œëŠ” ì•ˆ ëœë‹¤
        System.gc();
    }
}
```

---

## ê¶Œì¥í•˜ëŠ” AutoCloseable

* ìì›ì„ ë³´ìœ í•œ í´ë˜ìŠ¤ëŠ” ë°˜ë“œì‹œ `AutoCloseable`ì„ êµ¬í˜„í•´ì•¼ í•œë‹¤
* ì‚¬ìš©ìëŠ” `try-with-resources`ë¡œ ìì› ì‚¬ìš© ë²”ìœ„ë¥¼ ëª…í™•íˆ í•´ì•¼ í•œë‹¤

```java
public class AutoClosableIsGood implements Closeable {

    private BufferedReader reader;

    public AutoClosableIsGood(String path) {
        try {
            this.reader = new BufferedReader(new FileReader(path));
        } catch (FileNotFoundException e) {
            throw new IllegalArgumentException(path);
        }
    }

    @Override
    public void close() {
        try {
            reader.close();
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}
```

```java
public class App {

    public static void main(String[] args) {
        try (AutoClosableIsGood good = new AutoClosableIsGood("")) {
            // ìì› ì‚¬ìš©
        } // ìë™ ë°˜ë‚©
    }
}
```

---

## ì™„ë²½ ê³µëµ

* p42: Finalizer ê³µê²©
* p43: AutoCloseableì˜ í•„ìš”ì„±
* p45: ì •ì ì´ ì•„ë‹Œ ì¤‘ì²© í´ë˜ìŠ¤ëŠ” ë°”ê¹¥ ê°ì²´ì˜ ì°¸ì¡°ë¥¼ ê°€ì§„ë‹¤
* p45: ëŒë‹¤ ì—­ì‹œ ë°”ê¹¥ ê°ì²´ì˜ ì°¸ì¡°ë¥¼ ê°–ê¸° ì‰½ë‹¤

---

## ì •ì ì´ ì•„ë‹Œ ì¤‘ì²© í´ë˜ìŠ¤ì˜ ë¬¸ì œì 

```java
class InnerClass {
    public void hello() {
        OuterClass.this.hi();
    }
}
```

* non-static ì¤‘ì²© í´ë˜ìŠ¤ëŠ” ìë™ìœ¼ë¡œ ë°”ê¹¥ ê°ì²´ ì°¸ì¡°ë¥¼ ê°€ì§„ë‹¤
* Cleanerì˜ Runnableì´ ë°”ê¹¥ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ë©´ GCê°€ ë¶ˆê°€ëŠ¥í•´ì§„ë‹¤
* ë”°ë¼ì„œ Cleanerì—ì„œ ì‚¬ìš©í•˜ëŠ” Runnableì€ **ë°˜ë“œì‹œ static ì¤‘ì²© í´ë˜ìŠ¤ì—¬ì•¼ í•œë‹¤**
* Cleanerì˜ Runnableì´ outer ê°ì²´ë¥¼ ì°¸ì¡°í•˜ë©´?
  * GC ë¶ˆê°€
  * Cleanerê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ 
  * ìì› ëˆ„ìˆ˜

---

## ëŒë‹¤ ì—­ì‹œ ë°”ê¹¥ ê°ì²´ë¥¼ ìº¡ì²˜í•œë‹¤

```java
private Runnable instanceLambda = () -> {
    System.out.println(value);
};
```

* ëŒë‹¤ëŠ” ë°”ê¹¥ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‰½ê²Œ ìº¡ì²˜í•œë‹¤
* ê²°ê³¼ì ìœ¼ë¡œ this ì°¸ì¡°ê°€ ìˆ¨ì–´ ë“¤ì–´ê°„ë‹¤
* Cleanerì—ì„œ ì‚¬ìš©í•˜ë©´ ìˆœí™˜ ì°¸ì¡°ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤
* Cleaner ì‘ì—…ì—ëŠ” ëŒë‹¤ ì‚¬ìš©ì„ í”¼í•´ì•¼ í•œë‹¤

---



